<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>پنل مدیریت وبلاگ پیشرفته - عربی با ریحانه</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Vazirmatn", sans-serif;
      }
      .gradient-text {
        background: linear-gradient(to right, #10b981, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .blog-card {
        transition: all 0.3s ease;
      }
      .blog-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
      .tag {
        display: inline-block;
        background: #e0f2fe;
        color: #0369a1;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin: 2px;
      }
      .hashtag {
        color: #3b82f6;
        font-weight: 600;
      }
      .status-draft {
        background: #fef3c7;
        color: #92400e;
      }
      .status-published {
        background: #d1fae5;
        color: #065f46;
      }
      .status-archived {
        background: #f3f4f6;
        color: #374151;
      }
      .search-highlight {
        background: yellow;
        font-weight: bold;
      }
      .content-preview {
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        -webkit-backdrop-filter: blur(4px);
        backdrop-filter: blur(4px);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 2% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .close {
        color: #aaa;
        float: left;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover {
        color: black;
      }
      .tag-input {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        min-height: 40px;
        background: white;
      }
      .tag-item {
        background: #3b82f6;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
      }
      .tag-item .remove {
        cursor: pointer;
        font-weight: bold;
      }
      .tag-input input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 100px;
      }
      .performance-metric {
        display: inline-block;
        background: #eff6ff;
        color: #1e40af;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 4px;
      }
      .notification {
        position: fixed;
        top: 20px;
        left: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        max-width: 400px;
        opacity: 0;
        transform: translateX(-100%);
        transition: all 0.3s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateX(0);
      }
      .notification.success {
        background: #10b981;
        color: white;
      }
      .notification.error {
        background: #ef4444;
        color: white;
      }
      .blog-preview {
        background: white;
        border-radius: 8px;
        padding: 30px;
        margin: 20px 0;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .blog-preview h1 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #1f2937;
      }
      .blog-preview .meta {
        color: #6b7280;
        font-size: 0.9rem;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e5e7eb;
      }
      .blog-preview .content {
        line-height: 1.8;
        font-size: 1.1rem;
      }
      .blog-preview .content strong {
        font-weight: bold;
        color: #1f2937;
      }
      .blog-preview .content em {
        font-style: italic;
        color: #4b5563;
      }
      .blog-preview .hashtag {
        color: #3b82f6;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <header class="bg-white shadow-md">
      <div
        class="container mx-auto px-6 py-4 flex justify-between items-center"
      >
        <h1 class="text-2xl font-bold gradient-text">
          پنل مدیریت وبلاگ پیشرفته
        </h1>
        <div class="flex items-center space-x-reverse space-x-4">
          <div class="text-sm text-gray-600">
            <span id="current-time"></span>
          </div>
          <div
            class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold"
          >
            آنلاین
          </div>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-6 py-8">
      <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div
          class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-blue-100 text-sm">کل مقالات</p>
              <p class="text-3xl font-bold" id="total-blogs">0</p>
            </div>
            <i class="fas fa-blog text-4xl text-blue-200"></i>
          </div>
        </div>

        <div
          class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-green-100 text-sm">منتشر شده</p>
              <p class="text-3xl font-bold" id="published-blogs-stat">0</p>
            </div>
            <i class="fas fa-check-circle text-4xl text-green-200"></i>
          </div>
        </div>

        <div
          class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-xl"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-yellow-100 text-sm">پیش‌نویس</p>
              <p class="text-3xl font-bold" id="draft-blogs-stat">0</p>
            </div>
            <i class="fas fa-edit text-4xl text-yellow-200"></i>
          </div>
        </div>

        <div
          class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-purple-100 text-sm">تگ‌های فعال</p>
              <p class="text-3xl font-bold" id="total-tags">0</p>
            </div>
            <i class="fas fa-tags text-4xl text-purple-200"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg mb-8">
        <div class="flex border-b overflow-x-auto">
          <button
            class="blog-tab-btn active py-4 px-6 bg-blue-100 text-blue-700 font-semibold"
            data-target="blog-list"
          >
            <i class="fas fa-list ml-2"></i>لیست مقالات
          </button>
          <button
            class="blog-tab-btn py-4 px-6 text-gray-500 hover:bg-gray-100"
            data-target="create-blog"
          >
            <i class="fas fa-plus ml-2"></i>مقاله جدید
          </button>
          <button
            class="blog-tab-btn py-4 px-6 text-gray-500 hover:bg-gray-100"
            data-target="published-blogs"
          >
            <i class="fas fa-globe ml-2"></i>منتشر شده‌ها
          </button>
          <button
            class="blog-tab-btn py-4 px-6 text-gray-500 hover:bg-gray-100"
            data-target="draft-blogs"
          >
            <i class="fas fa-file-alt ml-2"></i>پیش‌نویس‌ها
          </button>
          <button
            class="blog-tab-btn py-4 px-6 text-gray-500 hover:bg-gray-100"
            data-target="tags-management"
          >
            <i class="fas fa-tags ml-2"></i>مدیریت تگ‌ها
          </button>
        </div>

        <div id="blog-list" class="blog-panel p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold gradient-text">لیست کامل مقالات</h2>
            <div class="flex items-center space-x-reverse space-x-4">
              <div class="relative">
                <input
                  type="text"
                  id="search-blogs"
                  placeholder="جستجو در مقالات..."
                  class="pl-10 pr-4 py-2 border rounded-lg w-64 focus:ring-2 focus:ring-blue-500"
                />
                <i
                  class="fas fa-search absolute right-3 top-3 text-gray-400"
                ></i>
              </div>
              <select id="filter-status" class="border rounded-lg px-4 py-2">
                <option value="">همه وضعیت‌ها</option>
                <option value="published">منتشر شده</option>
                <option value="draft">پیش‌نویس</option>
                <option value="archived">بایگانی شده</option>
              </select>
              <button
                onclick="switchToTab('create-blog')"
                class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600"
              >
                <i class="fas fa-plus ml-1"></i>مقاله جدید
              </button>
            </div>
          </div>

          <div class="bg-white border rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-right">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="p-3">عنوان</th>
                    <th class="p-3">وضعیت</th>
                    <th class="p-3">تگ‌ها</th>
                    <th class="p-3">تاریخ ایجاد</th>
                    <th class="p-3">آخرین بروزرسانی</th>
                    <th class="p-3">عملیات</th>
                  </tr>
                </thead>
                <tbody id="blogs-table"></tbody>
              </table>
            </div>
          </div>

          <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-600">
              نمایش <span id="showing-from">1</span> تا
              <span id="showing-to">10</span> از
              <span id="total-count">0</span> مقاله
            </div>
            <div class="flex space-x-reverse space-x-2">
              <button
                id="prev-page"
                class="px-3 py-1 border rounded hover:bg-gray-100"
                disabled
              >
                قبلی
              </button>
              <span
                id="current-page"
                class="px-3 py-1 bg-blue-100 text-blue-800 rounded"
                >1</span
              >
              <button
                id="next-page"
                class="px-3 py-1 border rounded hover:bg-gray-100"
              >
                بعدی
              </button>
            </div>
          </div>
        </div>

        <div id="create-blog" class="blog-panel p-8 hidden">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold gradient-text" id="form-title">
              ایجاد مقاله جدید
            </h2>
          </div>

          <form id="blog-creation-form" class="space-y-6">
            <input type="hidden" id="form-blog-id" />
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block font-semibold mb-2"
                  >عنوان مقاله (فارسی) *</label
                >
                <input
                  type="text"
                  id="blog-title"
                  required
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="مثال: ۵ تفاوت کلیدی لهجه عراقی و خلیجی"
                />
              </div>
              <div>
                <label class="block font-semibold mb-2"
                  >عنوان سئو (Meta Title)</label
                >
                <input
                  type="text"
                  id="blog-meta-title"
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder="این عنوان در نتایج گوگل نمایش داده می‌شود"
                />
              </div>
              <div>
                <label class="block font-semibold mb-2"
                  >آدرس تصویر شاخص (URL)</label
                >
                <input
                  type="url"
                  id="blog-featured-image"
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 text-left"
                  dir="ltr"
                  placeholder="https://example.com/image.jpg"
                />
              </div>
            </div>

            <div>
              <label class="block font-semibold mb-2">محتوای مقاله *</label>
              <div class="border rounded-lg">
                <div
                  class="bg-gray-50 p-2 border-b flex flex-wrap gap-2 text-sm"
                >
                  <button
                    type="button"
                    onclick="insertTag('**', '**')"
                    class="px-2 py-1 bg-white border rounded hover:bg-gray-100"
                  >
                    <i class="fas fa-bold"></i> ضخیم
                  </button>
                  <button
                    type="button"
                    onclick="insertTag('*', '*')"
                    class="px-2 py-1 bg-white border rounded hover:bg-gray-100"
                  >
                    <i class="fas fa-italic"></i> ایتالیک
                  </button>
                  <button
                    type="button"
                    onclick="insertTag('#', '')"
                    class="px-2 py-1 bg-white border rounded hover:bg-gray-100"
                  >
                    <i class="fas fa-hashtag"></i> هشتگ
                  </button>
                  <span class="text-gray-500 text-xs self-center"
                    >از ** برای متن ضخیم و * برای ایتالیک استفاده کنید</span
                  >
                </div>
                <textarea
                  id="blog-content"
                  required
                  rows="12"
                  class="w-full p-3 border-0 rounded-b-lg focus:ring-2 focus:ring-blue-500 resize-y"
                  placeholder="محتوای خود را اینجا وارد کنید...

مثال استفاده از فرمت:
**این متن ضخیم خواهد بود**
*این متن ایتالیک خواهد بود*
#آموزش_عربی #لهجه_عراقی

شما می‌توانید از این فرمت‌ها برای بهتر نمایان کردن محتوا استفاده کنید."
                ></textarea>
              </div>
              <div class="mt-2 text-sm text-gray-600">
                تعداد کلمات: <span id="word-count">0</span> | تعداد کاراکتر:
                <span id="char-count">0</span>
              </div>
            </div>

            <div>
              <label class="block font-semibold mb-2"
                >توضیحات سئو (Meta Description)</label
              >
              <textarea
                id="blog-meta-description"
                rows="3"
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                placeholder="توضیحاتی جذب‌کننده برای گوگل (حداکثر ۱۶۰ کاراکتر)"
                maxlength="160"
              ></textarea>
              <div class="mt-1 text-sm text-gray-500">
                <span id="meta-char-count">0</span>/160 کاراکتر
              </div>
            </div>

            <div>
              <label class="block font-semibold mb-2">تگ‌ها</label>
              <div class="tag-input" id="tag-input-container">
                <input
                  type="text"
                  id="tag-input-field"
                  placeholder="تگ جدید اضافه کنید و Enter بزنید..."
                  onkeypress="addTagOnEnter(event)"
                />
              </div>
              <div class="mt-2 text-sm text-gray-600">
                تگ‌های پیشنهادی:
                <button
                  type="button"
                  onclick="addSuggestedTag('آموزش_عربی')"
                  class="text-blue-500 hover:underline ml-2"
                >
                  آموزش_عربی
                </button>
                <button
                  type="button"
                  onclick="addSuggestedTag('گرامر_عربی')"
                  class="text-blue-500 hover:underline ml-2"
                >
                  گرامر_عربی
                </button>
                <button
                  type="button"
                  onclick="addSuggestedTag('لهجه')"
                  class="text-blue-500 hover:underline ml-2"
                >
                  لهجه
                </button>
                <button
                  type="button"
                  onclick="addSuggestedTag('مکالمه')"
                  class="text-blue-500 hover:underline ml-2"
                >
                  مکالمه
                </button>
              </div>
            </div>

            <div class="flex justify-between items-center">
              <div class="flex space-x-reverse space-x-4">
                <button
                  type="submit"
                  class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold"
                >
                  <i class="fas fa-save ml-1"></i>ذخیره به عنوان پیش‌نویس
                </button>
                <button
                  type="button"
                  onclick="publishBlog()"
                  class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 font-semibold"
                >
                  <i class="fas fa-globe ml-1"></i>ذخیره و انتشار
                </button>
              </div>
              <button
                type="button"
                onclick="previewBlog()"
                class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600"
              >
                <i class="fas fa-eye ml-1"></i>پیش‌نمایش
              </button>
            </div>
          </form>
        </div>

        <div id="published-blogs" class="blog-panel p-8 hidden">
          <h2 class="text-2xl font-bold mb-6 gradient-text">
            مقالات منتشر شده
          </h2>

          <div
            id="published-blogs-grid"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <div id="draft-blogs" class="blog-panel p-8 hidden">
          <h2 class="text-2xl font-bold mb-6 gradient-text">پیش‌نویس‌ها</h2>

          <div
            id="draft-blogs-grid"
            class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
        </div>

        <div id="tags-management" class="blog-panel p-8 hidden">
          <h2 class="text-2xl font-bold mb-6 gradient-text">مدیریت تگ‌ها</h2>

          <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-gray-50 p-6 rounded-xl">
              <h3 class="text-xl font-bold mb-4">تگ‌های موجود</h3>
              <div
                id="existing-tags"
                class="space-y-2 max-h-96 overflow-y-auto"
              ></div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl">
              <h3 class="text-xl font-bold mb-4">آمار تگ‌ها</h3>
              <canvas id="tagsChart" width="400" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="preview-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closePreview()">&times;</span>
        <div id="preview-content"></div>
      </div>
    </div>

    <div id="notification-container" class="fixed top-5 left-5 z-[10001]"></div>

    <script>
      // Global variables
      let currentPage = 1;
      let blogsPerPage = 5;
      let blogTags = [];
      let blogsData = [];
      let tagsChartInstance = null;

      // Sample data for demo
      function loadSampleData() {
        blogsData = [
          {
            id: 1,
            title_fa: "۵ تفاوت کلیدی لهجه عراقی و خلیجی",
            status: "published",
            tags: ["آموزش_عربی", "لهجه", "عراقی"],
            created_at: "2025-06-20 14:30:00",
            updated_at: "2025-06-21 11:00:00",
            content:
              "در این مقاله به بررسی **تفاوت‌های اصلی** میان لهجه عراقی و خلیجی می‌پردازیم. این دو لهجه از *مهمترین لهجه‌های* عربی هستند که در منطقه خاورمیانه رواج دارند.\n\n#آموزش_عربی #لهجه_عراقی\n\nلهجه عراقی دارای ویژگی‌های منحصر به فردی است که آن را از سایر لهجه‌های عربی متمایز می‌کند.",
            meta_title: "تفاوت لهجه عراقی و خلیجی - آموزش عربی",
            meta_description:
              "بررسی کامل ۵ تفاوت اصلی میان لهجه عراقی و خلیجی برای یادگیری بهتر زبان عربی",
          },
          {
            id: 2,
            title_fa: "روش‌های مؤثر یادگیری واژگان عربی",
            status: "draft",
            tags: ["آموزش_عربی", "واژگان", "روش_یادگیری"],
            created_at: "2025-06-19 10:15:00",
            updated_at: "2025-06-19 16:45:00",
            content:
              "یادگیری واژگان عربی یکی از **اساسی‌ترین مراحل** در تسلط بر این زبان است. در این مقاله روش‌های *علمی و عملی* برای یادگیری مؤثر واژگان ارائه می‌دهیم.\n\n#آموزش_عربی #یادگیری_واژگان\n\nاستفاده از کارت‌های واژگان یکی از بهترین روش‌هاست.",
            meta_title: "روش‌های یادگیری واژگان عربی",
            meta_description:
              "تکنیک‌های علمی و عملی برای یادگیری سریع و مؤثر واژگان عربی",
          },
          {
            id: 3,
            title_fa: "قواعد اساسی گرامر عربی برای مبتدیان",
            status: "published",
            tags: ["گرامر_عربی", "مبتدی", "آموزش_عربی"],
            created_at: "2025-06-18 09:00:00",
            updated_at: "2025-06-18 09:00:00",
            content:
              "گرامر عربی در ابتدا ممکن است کمی پیچیده به نظر برسد، اما با یادگیری **قواعد پایه** می‌توانید به سرعت پیشرفت کنید. این مقاله برای *زبان‌آموزان مبتدی* طراحی شده است.\n\n#گرامر_عربی",
            meta_title: "قواعد گرامر عربی برای مبتدیان",
            meta_description:
              "یادگیری پایه‌ای‌ترین و مهم‌ترین قواعد گرامر زبان عربی به زبانی ساده.",
          },
          {
            id: 4,
            title_fa: "اصطلاحات پرکاربرد روزمره در مکالمه عربی",
            status: "published",
            tags: ["مکالمه", "اصطلاحات", "روزمره"],
            created_at: "2025-06-15 18:00:00",
            updated_at: "2025-06-16 10:20:00",
            content:
              "برای اینکه مکالمه شما طبیعی‌تر به نظر برسد، باید با **اصطلاحات رایج** آشنا باشید. در اینجا لیستی از پرکاربردترین اصطلاحات روزمره عربی را برای شما آماده کرده‌ایم.\n\n#مکالمه_عربی",
            meta_title: "اصطلاحات پرکاربرد در مکالمه عربی",
            meta_description:
              "مجموعه‌ای از اصطلاحات و عبارات کلیدی برای استفاده در مکالمات روزمره عربی.",
          },
          {
            id: 5,
            title_fa: "بررسی سریال‌های عربی برای تقویت زبان",
            status: "draft",
            tags: ["لهجه", "یادگیری_با_فیلم", "مکالمه"],
            created_at: "2025-06-14 11:45:00",
            updated_at: "2025-06-14 11:45:00",
            content:
              "تماشای سریال یکی از **لذت‌بخش‌ترین روش‌ها** برای تقویت مهارت شنیداری و درک لهجه‌های مختلف است. در این پست چند سریال جذاب عربی را معرفی می‌کنیم.\n\n#عربی_با_فیلم",
            meta_title: "بهترین سریال‌های عربی برای یادگیری زبان",
            meta_description:
              "معرفی و بررسی سریال‌های محبوب عربی که به تقویت زبان و درک لهجه کمک می‌کنند.",
          },
          {
            id: 6,
            title_fa: "آشنایی با اعداد و شمارش در عربی",
            status: "archived",
            tags: ["مبتدی", "واژگان"],
            created_at: "2025-05-30 13:00:00",
            updated_at: "2025-06-02 15:00:00",
            content:
              "این مقاله به طور کامل به **آموزش اعداد** از ۱ تا ۱۰۰۰ در زبان عربی می‌پردازد. این یک درس *پایه و ضروری* برای همه زبان‌آموزان است.\n\n#اعداد_عربی",
            meta_title: "آموزش کامل اعداد در زبان عربی",
            meta_description:
              "یادگیری اعداد و نحوه شمارش در زبان عربی به همراه مثال‌های کاربردی.",
          },
        ];
        // Sort by latest updated
        blogsData.sort(
          (a, b) => new Date(b.updated_at) - new Date(a.updated_at)
        );
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        loadSampleData();
        initializeTabs();
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        refreshAllData();
        setupEventListeners();
      });

      function refreshAllData() {
        loadBlogStats();
        loadBlogsList();
        loadPublishedBlogsGrid();
        loadDraftsBlogsGrid();
        loadTagsManagement();
      }

      // Time and Date
      function updateCurrentTime() {
        const timeEl = document.getElementById("current-time");
        const now = new Date();
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        };
        timeEl.textContent = now.toLocaleDateString("fa-IR", options);
      }

      // Tabs
      function initializeTabs() {
        const tabButtons = document.querySelectorAll(".blog-tab-btn");
        tabButtons.forEach((button) => {
          button.addEventListener("click", () => {
            switchToTab(button.dataset.target);
          });
        });
      }

      function switchToTab(targetId) {
        const tabButtons = document.querySelectorAll(".blog-tab-btn");
        const blogPanels = document.querySelectorAll(".blog-panel");

        tabButtons.forEach((btn) => {
          if (btn.dataset.target === targetId) {
            btn.classList.add(
              "active",
              "bg-blue-100",
              "text-blue-700",
              "font-semibold"
            );
            btn.classList.remove("text-gray-500", "hover:bg-gray-100");
          } else {
            btn.classList.remove(
              "active",
              "bg-blue-100",
              "text-blue-700",
              "font-semibold"
            );
            btn.classList.add("text-gray-500", "hover:bg-gray-100");
          }
        });

        blogPanels.forEach((panel) => {
          if (panel.id === targetId) {
            panel.classList.remove("hidden");
          } else {
            panel.classList.add("hidden");
          }
        });

        if (targetId === "create-blog") {
          resetCreationForm();
        }
      }

      // Stats
      function loadBlogStats() {
        const total = blogsData.length;
        const published = blogsData.filter(
          (b) => b.status === "published"
        ).length;
        const draft = blogsData.filter((b) => b.status === "draft").length;

        const allTags = new Set(blogsData.flatMap((b) => b.tags));

        document.getElementById("total-blogs").textContent = total;
        document.getElementById("published-blogs-stat").textContent = published;
        document.getElementById("draft-blogs-stat").textContent = draft;
        document.getElementById("total-tags").textContent = allTags.size;
      }

      // Blog List Table
      function loadBlogsList() {
        const tableBody = document.getElementById("blogs-table");
        const searchTerm = document
          .getElementById("search-blogs")
          .value.toLowerCase();
        const filterStatus = document.getElementById("filter-status").value;

        let filteredBlogs = blogsData.filter((blog) => {
          const matchesSearch =
            blog.title_fa.toLowerCase().includes(searchTerm) ||
            blog.content.toLowerCase().includes(searchTerm) ||
            blog.tags.some((t) => t.toLowerCase().includes(searchTerm));
          const matchesStatus = filterStatus
            ? blog.status === filterStatus
            : true;
          return matchesSearch && matchesStatus;
        });

        const totalCount = filteredBlogs.length;
        const totalPages = Math.ceil(totalCount / blogsPerPage);
        currentPage = Math.min(currentPage, totalPages || 1);

        const startIndex = (currentPage - 1) * blogsPerPage;
        const endIndex = startIndex + blogsPerPage;
        const paginatedBlogs = filteredBlogs.slice(startIndex, endIndex);

        tableBody.innerHTML = "";
        if (paginatedBlogs.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-gray-500">مقاله‌ای یافت نشد.</td></tr>`;
        } else {
          paginatedBlogs.forEach((blog) => {
            const row = document.createElement("tr");
            row.className = "border-b hover:bg-gray-50";
            row.innerHTML = `
                        <td class="p-4 font-semibold">${highlightSearchTerm(
                          blog.title_fa,
                          searchTerm
                        )}</td>
                        <td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full status-${
                          blog.status
                        }">${getStatusText(blog.status)}</span></td>
                        <td class="p-4">${blog.tags
                          .map((tag) => `<span class="tag">${tag}</span>`)
                          .join("")}</td>
                        <td class="p-4 text-sm text-gray-600">${formatDate(
                          blog.created_at
                        )}</td>
                        <td class="p-4 text-sm text-gray-600">${formatDate(
                          blog.updated_at
                        )}</td>
                        <td class="p-4 flex space-x-reverse space-x-2">
                            <button onclick="editBlog(${
                              blog.id
                            })" class="text-blue-500 hover:text-blue-700" title="ویرایش"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteBlog(${
                              blog.id
                            })" class="text-red-500 hover:text-red-700" title="حذف"><i class="fas fa-trash"></i></button>
                            <button onclick="changeStatus(${blog.id}, '${
              blog.status === "published" ? "archived" : "published"
            }')" class="text-gray-500 hover:text-gray-700" title="${
              blog.status === "published" ? "بایگانی" : "انتشار"
            }">
                                <i class="fas fa-${
                                  blog.status === "published"
                                    ? "archive"
                                    : "globe"
                                }"></i>
                            </button>
                        </td>
                    `;
            tableBody.appendChild(row);
          });
        }
        updatePaginationControls(totalCount, startIndex, paginatedBlogs.length);
      }

      function highlightSearchTerm(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, "gi");
        return text.replace(regex, '<span class="search-highlight">$1</span>');
      }

      // Pagination
      function updatePaginationControls(
        totalCount,
        startIndex,
        displayedCount
      ) {
        const totalPages = Math.ceil(totalCount / blogsPerPage);
        document.getElementById("total-count").textContent = totalCount;
        document.getElementById("showing-from").textContent =
          totalCount > 0 ? startIndex + 1 : 0;
        document.getElementById("showing-to").textContent =
          startIndex + displayedCount;
        document.getElementById("current-page").textContent = currentPage;

        document.getElementById("prev-page").disabled = currentPage === 1;
        document.getElementById("next-page").disabled =
          currentPage === totalPages || totalPages === 0;
      }

      // Event Listeners
      function setupEventListeners() {
        document
          .getElementById("search-blogs")
          .addEventListener("keyup", () => {
            currentPage = 1;
            loadBlogsList();
          });
        document
          .getElementById("filter-status")
          .addEventListener("change", () => {
            currentPage = 1;
            loadBlogsList();
          });
        document.getElementById("prev-page").addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            loadBlogsList();
          }
        });
        document.getElementById("next-page").addEventListener("click", () => {
          currentPage++;
          loadBlogsList();
        });
        document
          .getElementById("blog-creation-form")
          .addEventListener("submit", handleBlogFormSubmit);

        // Word/Char counters
        const contentArea = document.getElementById("blog-content");
        contentArea.addEventListener("input", () => {
          const text = contentArea.value;
          const words = text.trim().split(/\s+/).filter(Boolean);
          document.getElementById("word-count").textContent = words.length;
          document.getElementById("char-count").textContent = text.length;
        });

        const metaDescArea = document.getElementById("blog-meta-description");
        metaDescArea.addEventListener("input", () => {
          document.getElementById("meta-char-count").textContent =
            metaDescArea.value.length;
        });
      }

      // Form Handling
      function handleBlogFormSubmit(event) {
        event.preventDefault();
        saveBlog("draft");
      }

      function publishBlog() {
        saveBlog("published");
      }

      function saveBlog(status) {
    const title = document.getElementById("blog-title").value.trim();
    const content = document.getElementById("blog-content").value.trim();
    const featuredImage = document.getElementById("blog-featured-image").value.trim();
    const blogId = document.getElementById("form-blog-id").value;

    if (!title || !content) {
        showNotification("عنوان و محتوای مقاله الزامی است.", "error");
        return;
    }
    const blogData = {
        title_fa: title,
        content: content,
        meta_title: document.getElementById("blog-meta-title").value,
        meta_description: document.getElementById("blog-meta-description").value,
        tags: blogTags.join(","), 
        featured_image: featuredImage,
        admin_id: 1,
    };

    let apiUrl = 'api/blog_api.php';
    let method = 'POST';
    if (blogId) {
        blogData.blog_id = blogId;
        blogData.action = 'update';
        method = 'PUT';
    } else {
        blogData.action = 'create';
    }
    
    fetch(apiUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(blogData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (status === 'published') {
                return fetch('api/blog_api.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'publish', blog_id: blogId || data.blog_id })
                });
            }
            return { success: true }; 
        } else {
            throw new Error(data.error || 'خطا در ذخیره مقاله.');
        }
    })
    .then(publishResponse => {
         if (publishResponse && publishResponse.ok) return publishResponse.json();
         return publishResponse;
    })
    .then(publishData => {
         if (publishData && !publishData.success) throw new Error('مقاله ذخیره شد اما در انتشار خطا رخ داد.');

         const message = blogId ? "مقاله با موفقیت بروزرسانی شد." : `مقاله به عنوان ${getStatusText(status)} ذخیره شد.`;
         showNotification(message, 'success');
         resetCreationForm();
         switchToTab('blog-list');
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(error.message, 'error');
    });
}

      function resetCreationForm() {
        document.getElementById("blog-creation-form").reset();
        document.getElementById("form-blog-id").value = "";
        document.getElementById("form-title").textContent = "ایجاد مقاله جدید";
        document.getElementById("word-count").textContent = 0;
        document.getElementById("char-count").textContent = 0;
        document.getElementById("meta-char-count").textContent = 0;
        resetTagInput();
      }

      // Blog Actions (Edit, Delete, Change Status)
      function editBlog(id) {
        const blog = blogsData.find((b) => b.id === id);
        if (blog) {
          switchToTab("create-blog");
          document.getElementById("form-title").textContent = "ویرایش مقاله";
          document.getElementById("form-blog-id").value = blog.id;
          document.getElementById("blog-title").value = blog.title_fa;
          document.getElementById("blog-content").value = blog.content;
          document.getElementById("blog-meta-title").value = blog.meta_title;
          document.getElementById("blog-meta-description").value =
          document.getElementById('blog-featured-image').value = blog.featured_image || ''; 

            blog.meta_description;

          // Load tags
          resetTagInput();
          blog.tags.forEach((tag) => createTagElement(tag));

          // Trigger counters update
          document
            .getElementById("blog-content")
            .dispatchEvent(new Event("input"));
          document
            .getElementById("blog-meta-description")
            .dispatchEvent(new Event("input"));
        }
      }

      function deleteBlog(id) {
        if (
          confirm(
            "آیا از حذف این مقاله اطمینان دارید؟ این عمل غیرقابل بازگشت است."
          )
        ) {
          blogsData = blogsData.filter((b) => b.id !== id);
          showNotification("مقاله با موفقیت حذف شد.", "success");
          refreshAllData();
        }
      }

      function changeStatus(id, newStatus) {
        const blogIndex = blogsData.findIndex((b) => b.id === id);
        if (blogIndex > -1) {
          blogsData[blogIndex].status = newStatus;
          blogsData[blogIndex].updated_at = new Date()
            .toISOString()
            .slice(0, 19)
            .replace("T", " ");
          showNotification(
            `وضعیت مقاله به ${getStatusText(newStatus)} تغییر یافت.`,
            "success"
          );
          refreshAllData();
        }
      }

      // Tagging System
      function addTagOnEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          const input = event.target;
          const tagText = input.value.trim();
          if (tagText) {
            createTagElement(tagText);
            input.value = "";
          }
        }
      }

      function addSuggestedTag(tag) {
        createTagElement(tag);
      }

      function createTagElement(tag) {
        if (blogTags.includes(tag)) {
          // Prevent duplicates
          return;
        }
        blogTags.push(tag);

        const tagContainer = document.getElementById("tag-input-container");
        const inputField = document.getElementById("tag-input-field");

        const tagItem = document.createElement("span");
        tagItem.className = "tag-item";
        tagItem.innerHTML = `
                ${tag}
                <span class="remove" onclick="removeTag(this.parentElement, '${tag}')">&times;</span>
            `;
        tagContainer.insertBefore(tagItem, inputField);
      }

      function removeTag(tagElement, tag) {
        blogTags = blogTags.filter((t) => t !== tag);
        tagElement.remove();
      }

      function resetTagInput() {
        blogTags = [];
        const tagContainer = document.getElementById("tag-input-container");
        tagContainer.querySelectorAll(".tag-item").forEach((el) => el.remove());
      }

      // Modal (Preview)
      function previewBlog() {
        const title = document.getElementById("blog-title").value;
        const content = document.getElementById("blog-content").value;
        const tags = blogTags;

        const previewContainer = document.getElementById("preview-content");

        // Simple markdown-like parser
        let formattedContent = content
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // Bold
          .replace(/\*(.*?)\*/g, "<em>$1</em>") // Italic
          .replace(/#(\S+)/g, '<span class="hashtag">#$1</span>') // Hashtags
          .replace(/\n/g, "<br>"); // Newlines

        previewContainer.innerHTML = `
                <div class="blog-preview">
                    <h1>${title || "بدون عنوان"}</h1>
                    <div class="meta">
                        <span>نویسنده: شما</span> | <span>تاریخ: امروز</span>
                        <div class="mt-2">
                           ${tags
                             .map((tag) => `<span class="tag">${tag}</span>`)
                             .join("")}
                        </div>
                    </div>
                    <div class="content">
                        ${formattedContent || "محتوایی برای نمایش وجود ندارد."}
                    </div>
                </div>
            `;
        document.getElementById("preview-modal").style.display = "block";
      }

      function closePreview() {
        document.getElementById("preview-modal").style.display = "none";
      }

      // Other Tabs (Published, Drafts, Tags)
      function loadPublishedBlogsGrid() {
        const grid = document.getElementById("published-blogs-grid");
        const published = blogsData.filter((b) => b.status === "published");
        grid.innerHTML =
          published.length > 0
            ? published.map((blog) => createBlogCard(blog)).join("")
            : '<p class="text-gray-500 col-span-3 text-center">مقاله‌ی منتشر شده‌ای وجود ندارد.</p>';
      }

      function loadDraftsBlogsGrid() {
        const grid = document.getElementById("draft-blogs-grid");
        const drafts = blogsData.filter((b) => b.status === "draft");
        grid.innerHTML =
          drafts.length > 0
            ? drafts.map((blog) => createBlogCard(blog)).join("")
            : '<p class="text-gray-500 col-span-3 text-center">پیش‌نویسی وجود ندارد.</p>';
      }

      function createBlogCard(blog) {
        const cleanContent = blog.content.replace(/\*\*|\*|#\S+/g, "");
        return `
                <div class="blog-card bg-white p-5 rounded-xl border">
                    <h3 class="font-bold text-lg mb-2">${blog.title_fa}</h3>
                    <p class="text-gray-600 text-sm content-preview mb-3">${cleanContent}</p>
                    <div class="mb-3">${blog.tags
                      .map((tag) => `<span class="tag">${tag}</span>`)
                      .join("")}</div>
                    <div class="text-xs text-gray-500 border-t pt-3 flex justify-between">
                        <span>آخرین ویرایش: ${formatDate(
                          blog.updated_at
                        )}</span>
                        <div>
                             <button onclick="editBlog(${
                               blog.id
                             })" class="text-blue-500 hover:text-blue-700 ml-2" title="ویرایش"><i class="fas fa-pen"></i></button>
                             <button onclick="deleteBlog(${
                               blog.id
                             })" class="text-red-500 hover:text-red-700" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `;
      }

      function loadTagsManagement() {
        const tagCounts = {};
        blogsData.forEach((blog) => {
          blog.tags.forEach((tag) => {
            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
          });
        });

        const sortedTags = Object.entries(tagCounts).sort(
          (a, b) => b[1] - a[1]
        );

        const tagsListContainer = document.getElementById("existing-tags");
        tagsListContainer.innerHTML = sortedTags
          .map(
            ([tag, count]) => `
                <div class="flex justify-between items-center bg-white p-2 rounded-lg border">
                    <span class="font-semibold">${tag}</span>
                    <span class="text-sm text-gray-600 bg-gray-100 px-2 rounded-full">${count} مقاله</span>
                </div>
            `
          )
          .join("");

        // Chart.js
        const ctx = document.getElementById("tagsChart").getContext("2d");
        const topTags = sortedTags.slice(0, 10); // Show top 10 tags
        const labels = topTags.map((t) => t[0]);
        const data = topTags.map((t) => t[1]);

        if (tagsChartInstance) {
          tagsChartInstance.destroy();
        }

        tagsChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "تعداد استفاده از تگ",
                data: data,
                backgroundColor: "rgba(59, 130, 246, 0.5)",
                borderColor: "rgba(59, 130, 246, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      // Utils
      function getStatusText(status) {
        switch (status) {
          case "published":
            return "منتشر شده";
          case "draft":
            return "پیش‌نویس";
          case "archived":
            return "بایگانی شده";
          default:
            return "نامشخص";
        }
      }

      function formatDate(dateString) {
        const options = { year: "numeric", month: "2-digit", day: "2-digit" };
        return new Date(dateString).toLocaleDateString("fa-IR", options);
      }

      function showNotification(message, type = "success") {
        const container = document.getElementById("notification-container");
        const notif = document.createElement("div");
        notif.className = `notification ${type}`;
        notif.textContent = message;

        container.appendChild(notif);

        setTimeout(() => {
          notif.classList.add("show");
        }, 10);

        setTimeout(() => {
          notif.classList.remove("show");
          notif.addEventListener("transitionend", () => notif.remove());
        }, 4000);
      }

      // Rich Text Editor Helpers
      function insertTag(startTag, endTag) {
        const textarea = document.getElementById("blog-content");
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        const newText = startTag + selectedText + endTag;

        textarea.setRangeText(newText, start, end, "end");
        textarea.focus();
        textarea.dispatchEvent(new Event("input")); // To update counters
      }
    </script>
  </body>
</html>
